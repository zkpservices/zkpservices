<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <h3>Input JSON:</h3>
    <textarea id="input" rows="10" cols="30">
      {
        "city": "Stockholm",
        "coords": {
          "lat": 59.331924,
          "long": 18.062297
        },
        "measurements": [
          {
            "time": 1624363200,
            "temp": {"val": 28, "unit": "C"},
            "wind": {"val": 2.8, "dir": 290, "unit": "m/s"}
          },
          {
            "time": 1624366800,
            "temp": {"val": 26, "unit": "C"}
          }
        ]
      }
    </textarea>
    </br>
    <button onclick="run()">Compute Hashes</button>

    <h3>Flattened JSON:</h3>
    <textarea id="flattened" rows="10" cols="30"></textarea>

    <h3>Root Hash:</h3>
    <input type="text" id="rootHash" disabled>

    <h3>Input Key to Verify:</h3>
    <input type="text" id="keyToVerify">
    <h3>Input Hash of Key to Verify:</h3>
    <input type="text" id="hashToVerify">
    <h3>Input Index of Key:</h3>
    <input type="number" id="keyIndex">
    <button onclick="verify()">Verify</button>
    <p id="verificationResult"></p>

    <h3>Input all hashes:</h3>
    <textarea id="allHashes" rows="10" cols="30"></textarea>
    <button onclick="verifyAll()">Verify All</button>
    <p id="allVerificationResult"></p>

    <script>
      function flattenObject(ob) {
        var toReturn = {};

        for (var i in ob) {
            if (!ob.hasOwnProperty(i)) continue;

            if ((typeof ob[i]) == 'object' && ob[i] !== null) {
                var flatObject = flattenObject(ob[i]);
                for (var x in flatObject) {
                    if (!flatObject.hasOwnProperty(x)) continue;

                    toReturn[i + '.' + x] = flatObject[x];
                }
            } else {
                toReturn[i] = ob[i];
            }
        }
        return toReturn;
      };

      function sortObject(obj) {
        return Object.entries(obj)
          .sort((a, b) => {
            // Compare keys
            let comp = a[0].localeCompare(b[0]);
            if(comp !== 0)
              return comp;

            // If keys are equal, compare values
            return String(a[1]).localeCompare(String(b[1]));
          })
          .reduce((result, [key, value]) => {
            result[key] = value;
            return result;
          }, {});
      }

      async function hashSHA256(message) {
        const encoder = new TextEncoder();
        const data = encoder.encode(message);
        const hash = await window.crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash))
          .map(b => b.toString(16).padStart(2, '0'))
          .join('');
      }

      async function flattenJsonAndComputeHash(data) {
        let flatJson = flattenObject(data);
        let sorted = sortObject(flatJson);

        let hashes = await Promise.all(
          Object.entries(sorted).map(async ([key, value]) => {
            let hash = await hashSHA256(key + value);
            return hash;
          })
        );

        let rootHash = await hashSHA256(hashes.join(''));
        return { sorted, hashes, rootHash };
      }

      async function run() {
        let input = document.getElementById("input").value;
        let json_like = JSON.parse(input);

        let { sorted, hashes, rootHash } = await flattenJsonAndComputeHash(json_like);
        document.getElementById("flattened").value = JSON.stringify(sorted, null, 2);
        document.getElementById("rootHash").value = rootHash;
        document.getElementById("allHashes").value = JSON.stringify(hashes, null, 2);
      }

      async function verify() {
        let keyToVerify = document.getElementById("keyToVerify").value;
        let hashToVerify = document.getElementById("hashToVerify").value;
        let keyIndex = document.getElementById("keyIndex").value;

        let flattened = JSON.parse(document.getElementById("flattened").value);
        let hashForKey = await hashSHA256(keyToVerify + flattened[keyToVerify]);
        let rootHash = document.getElementById("rootHash").value;

        let allHashes = JSON.parse(document.getElementById("allHashes").value);
        let computedRootHash = await hashSHA256(allHashes.join(''));

        let verificationResult = (hashForKey === hashToVerify) && (keyIndex == allHashes.indexOf(hashForKey)) && (rootHash === computedRootHash);
        document.getElementById("verificationResult").textContent = `Verification result: ${verificationResult}`;
      }

      async function verifyAll() {
        let allHashes = JSON.parse(document.getElementById("allHashes").value);
        let rootHash = document.getElementById("rootHash").value;

        let computedRootHash = await hashSHA256(allHashes.join(''));
        let verificationResult = rootHash === computedRootHash;
        document.getElementById("allVerificationResult").textContent = `Verification result: ${verificationResult}, ${computedRootHash}`;

    }

    </script>
  </body>
</html>
